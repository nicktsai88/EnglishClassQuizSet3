<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Reading Comprehension Quiz (Firebase Edition)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            /* Color Scheme */
            --primary-color: #1565c0;   /* Blue for English */
            --secondary-color: #42a5f5; 
            --bg-color: #e3f2fd;        
            --text-color: #0d47a1;      
            --accent-color: #ff6f00;    
            --correct-color: #2e7d32;   
            --wrong-color: #c62828;     
            --favorite-color: #ad1457;  
            --player-bg: #ffffff;
            --header-height: 70px;      /* Modified height to 70px */
        }

        * { box-sizing: border-box; } /* Global Box Sizing */

        body { 
            font-family: 'Noto Sans TC', "Microsoft JhengHei", Arial, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            /* Fixed padding for full-screen feel */
            padding: calc(var(--header-height) + 10px) 10px 10px 10px; 
            background-color: var(--bg-color); 
            color: var(--text-color);
            background-image: 
                radial-gradient(var(--secondary-color) 0.5px, transparent 0.5px),
                radial-gradient(var(--secondary-color) 0.5px, transparent 0.5px);
            background-position: 0 0, 25px 25px;
            background-size: 50px 50px;
            background-attachment: fixed;
            height: 100vh; /* Fixed body height */
            overflow: hidden; /* Prevent body scroll */
        }

        h1, h2, h3 { text-align: center; color: var(--text-color); }
        h1 { color: var(--primary-color); text-shadow: 1px 1px 2px rgba(0,0,0,0.1); margin-top: 0;}

        /* --- Music Player Bar --- */
        #music-player-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--header-height);
            background-color: var(--player-bg); border-bottom: 3px solid var(--primary-color);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; align-items: center;
            justify-content: space-between; padding: 0 15px; box-sizing: border-box;
            z-index: 10000;
        }
        .player-left { flex: 0 0 auto; display: flex; justify-content: flex-start; margin-right: 15px; }
        
        /* Updated Player Center for Horizontal Layout */
        .player-center { 
            flex: 1; 
            display: flex; 
            flex-direction: row; /* Horizontal on desktop */
            justify-content: center; 
            align-items: center; 
            overflow: hidden;
            margin: 0 10px;
        }
        .player-right { flex: 0 0 auto; display: flex; justify-content: flex-end; align-items: center; gap: 10px; }
        
        .player-icon { font-size: 1.5em; background: #e3f2fd; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 2px solid var(--primary-color); color: var(--primary-color);}

        /* Song Title Styles */
        .song-info-container {
            width: 100%;
            max-width: 300px;
            background: #f1f8e9;
            border-radius: 20px;
            padding: 5px 15px;
            margin-bottom: 0; /* Removed bottom margin for desktop row layout */
            margin-right: 15px; /* Add space between title and buttons */
            border: 1px solid #c5e1a5;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            position: relative;
        }
        .song-title {
            font-size: 0.9em;
            color: #33691e;
            font-weight: bold;
            display: inline-block;
        }
        /* Marquee effect for long titles */
        .scrolling-text {
            animation: marquee 20s linear infinite; /* Slower speed (20s) */
            padding-left: 100%;
        }
        @keyframes marquee {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-100%, 0); }
        }
        
        .player-controls { display: flex; align-items: center; gap: 8px; }
        .ctrl-btn { background: none; border: none; cursor: pointer; color: #78909c; font-size: 1.4em; padding: 5px; transition: color 0.2s;}
        .ctrl-btn:hover, .ctrl-btn.active { color: var(--primary-color); transform: scale(1.1); }
        .volume-container { display: flex; align-items: center; gap: 5px; margin-left: 5px;}
        .volume-slider { width: 60px; accent-color: var(--primary-color); cursor: pointer;}
        
        .mode-btn { border: 1px solid #bdc3c7; background: #fff; padding: 5px 10px; border-radius: 20px; font-size: 0.8em; cursor: pointer; display: flex; align-items: center; gap: 5px;}
        .mode-btn:hover { border-color: var(--primary-color); color: var(--primary-color); }

        /* --- Containers --- */
        .container-box {
            background: rgba(255, 255, 255, 0.95); padding: 25px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05);
            backdrop-filter: blur(10px); position: relative; margin-bottom: 20px;
            max-height: 100%;
            overflow-y: auto;
        }

        /* --- Welcome Screen --- */
        #welcome-screen {
            background: linear-gradient(rgba(255,255,255,0.8), rgba(255,255,255,0.8)), url('images/background.jpg');
            background-size: cover; background-position: center; border-left: 6px solid var(--primary-color);
        }
        .avatar-selection { display: flex; justify-content: center; gap: 15px; margin: 20px 0; }
        .avatar-option {
            width: 80px; height: 80px; border-radius: 50%; border: 4px solid #fff; cursor: pointer;
            transition: 0.3s; object-fit: cover; background: #FFF; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .avatar-option.selected { border-color: var(--primary-color); transform: scale(1.1); }
        .quick-login-area { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 15px; }
        .user-tag { background: #fff; border: 1px solid #bdc3c7; padding: 6px 15px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.95em;}
        .delete-user { font-weight: bold; padding: 2px 6px; border-radius: 50%; background: #eee; color: #888; }
        .delete-user:hover { background: var(--wrong-color); color: #fff; }
        input[type="text"] { padding: 12px; font-size: 1.2em; border: 2px solid #bdc3c7; border-radius: 30px; width: 80%; text-align: center; margin: 10px 0;}

        /* --- Dashboard (Level Screen) --- */
        #level-screen-content {
            display: flex; gap: 20px; align-items: flex-start;
            min-height: 400px;
            justify-content: center;
        }
        
        /* Dashboard Background */
        #level-screen {
            background: linear-gradient(rgba(255,255,255,0.8), rgba(255,255,255,0.8)), url('images/background.jpg');
            background-size: cover; background-position: center;
        }

        /* Left: Standard Zone */
        .dashboard-std-zone {
            flex: 1; border: 1px solid #e1e8ed; border-radius: 12px; padding: 20px;
            background: rgba(255,255,255,0.85); max-width: 900px;
        }
        .dashboard-title { 
            font-size: 1.4em; color: var(--primary-color); margin-bottom: 15px; 
            display: flex; align-items: center; gap: 10px; border-bottom: 2px solid #bbdefb; padding-bottom: 10px;
            justify-content: space-between;
        }

        .overall-progress { font-size: 0.9em; color: #555; background: #fff; padding: 5px 15px; border-radius: 15px; border: 1px solid #ddd; }

        /* Grid Layout for Levels */
        .level-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 20px; justify-items: center;
        }
        .level-grid-btn {
            width: 100%; aspect-ratio: 1; min-height: 120px; 
            border-radius: 15px;
            background: #fff; border: 3px solid var(--primary-color);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; transition: 0.2s; box-shadow: 0 4px 0 #90caf9; color: var(--text-color);
            padding: 10px;
        }
        .level-grid-btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 6px 0 #90caf9; background: #e3f2fd; }
        .level-grid-btn:active:not(:disabled) { transform: translateY(2px); box-shadow: none; }
        .level-grid-btn:disabled { border-color: #bdc3c7; color: #bdc3c7; background: #f0f0f0; cursor: not-allowed; box-shadow: none;}
        
        .lvl-icon { 
            font-size: 3em; 
            margin-bottom: 8px; 
            font-family: "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji", "Android Emoji", sans-serif;
            line-height: 1.1;
        }
        
        .lvl-score { font-size: 0.9em; font-weight: bold; color: var(--correct-color); background: #e8f5e9; padding: 2px 8px; border-radius: 10px; margin-top: 5px; }
        .lvl-label { font-size: 1.1em; font-weight: bold; }
        
        /* Dashboard Tools */
        .dashboard-tools {
            margin-top: 20px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;
            padding-top: 20px; border-top: 1px solid #ddd;
        }
        
        /* --- Button Styles --- */
        .btn { padding: 10px 24px; border-radius: 25px; border: none; cursor: pointer; font-weight: bold; font-size: 1.1em; transition: 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: #fff; background: var(--primary-color); display: inline-flex; align-items: center; gap: 5px;}
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 10px rgba(0,0,0,0.15); }
        .btn-red { background: var(--wrong-color); } .btn-red:hover { background: #b71c1c; }
        .btn-green { background: var(--correct-color); } .btn-green:hover { background: #1b5e20; }
        .btn-pink { background: var(--favorite-color); } .btn-pink:hover { background: #880e4f; }
        .btn-gray { background: #607d8b; } .btn-gray:hover { background: #455a64; }
        .btn-blue { background: #0277bd; } .btn-blue:hover { background: #01579b; }
        .btn-orange { background: var(--accent-color); } .btn-orange:hover { background: #e65100; }

        /* --- Standard Quiz Mode (Reading Comprehension) --- */
        #quiz-content {
            /* Fix height to viewport minus header and padding */
            height: calc(100vh - 120px);
            display: none; /* Controlled by JS */
            flex-direction: column;
            overflow: hidden; /* Prevent container itself from scrolling */
            padding-bottom: 0;
        }

        .quiz-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 10px; 
            flex: 0 0 auto; 
        }
        
        .progress-bar-container { 
            width: 100%; 
            background: #e0e0e0; 
            height: 10px; 
            border-radius: 5px; 
            overflow: hidden; 
            margin-bottom: 5px; 
            flex: 0 0 auto;
        }
        .progress-bar-fill { height: 100%; background: var(--secondary-color); width: 0%; transition: width 0.3s; }
        
        .status-bar {
            text-align: right; 
            margin-bottom: 10px; 
            font-weight: bold; 
            color: #777;
            flex: 0 0 auto;
        }

        /* Layout for Question Container */
        #question-container {
            flex: 1; /* Takes all remaining height */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Clip anything spilling out */
            min-height: 0; /* Flexbox scroll fix */
        }

        .question-box { 
            background: #fff; 
            padding: 0;
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            margin-bottom: 0; 
            display: flex;
            /* Changed to ROW for side-by-side layout */
            flex-direction: row;
            overflow: hidden;
            border-top: 5px solid var(--primary-color);
            height: 100%; /* Fill container */
        }

        .article-section {
            width: 50%;
            padding: 20px;
            background: #fafafa;
            border-right: 2px solid #ddd; /* Divider line */
            
            /* Scrolling for left side */
            height: 100%;
            overflow-y: auto; 
        }

        .questions-section {
            width: 50%;
            padding: 20px;
            background: #fff;
            
            /* Scrolling for right side */
            height: 100%;
            overflow-y: auto;
            padding-bottom: 80px; /* Space for the floating button */
        }

        .article-content { 
            font-size: 1.2em; line-height: 2; color: #2c3e50; 
            text-align: justify;
        }
        
        /* New Styles for Readability */
        .dialogue-name {
            color: #c62828; /* Strong Red */
            font-weight: 800;
            margin-right: 5px;
            font-family: 'Arial Rounded MT Bold', 'Noto Sans TC', sans-serif;
        }

        .story-box {
            background-color: #f1f8e9; /* Very light green */
            padding: 15px;
            border-left: 5px solid var(--correct-color);
            margin: 15px 0;
            font-style: italic;
            border-radius: 5px;
            line-height: 1.8;
            color: #33691e;
        }

        .highlight-term {
            background-color: #fff9c4; /* Highlight yellow */
            padding: 0 5px;
            border-radius: 3px;
            font-weight: bold;
            color: #f57f17;
            border: 1px solid #fbc02d;
        }

        .article-title-bar {
            display: flex; justify-content: center; align-items: center; gap: 10px;
            border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; 
        }
        .article-title { font-size: 1.6em; font-weight: bold; color: var(--primary-color); margin: 0; }
        
        .fav-heart {
            font-size: 2em; cursor: pointer; color: #ccc; transition: 0.3s;
        }
        .fav-heart.active { color: var(--favorite-color); }
        .fav-heart:hover { transform: scale(1.1); }
        .fav-heart:active { transform: scale(0.9); }

        .sub-question-item { margin-bottom: 30px; border-bottom: 1px dashed #eee; padding-bottom: 20px; }
        .sub-question-item:last-child { border-bottom: none; }
        .sub-q-text { font-size: 1.25em; font-weight: bold; margin-bottom: 15px; color: #2c3e50; }
        
        .option-list { list-style: none; padding: 0; }
        .option-btn { width: 100%; padding: 15px; margin-bottom: 10px; background: #fff; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; font-size: 1.35em; text-align: left; transition: 0.2s; position: relative; }
        .option-btn:hover:not(:disabled) { border-color: var(--primary-color); background: #e3f2fd; }
        .option-btn.selected { border-color: var(--primary-color); background: #e3f2fd; font-weight: bold; }
        .option-btn.correct { background: #d4edda; border-color: var(--correct-color); color: #155724; }
        .option-btn.wrong { background: #f8d7da; border-color: var(--wrong-color); color: #721c24; }
        
        .option-btn img { max-height: 150px; display: block; margin: 5px 0; }
        .article-content img { max-width: 100%; height: auto; display: block; margin: 10px auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }

        .single-explanation { 
            background: #fff3e0; 
            padding: 15px; 
            border-radius: 8px; 
            border: 1px solid #ffe0b2; 
            border-left: 5px solid #ff9800; 
            margin-top: 15px; 
            display: none; 
            line-height: 1.6; 
            font-size: 1.35em; 
            color: #3e2723;
            animation: fadeIn 0.5s;
        }

        /* Floating Next Button */
        #next-btn {
            position: absolute; /* Modified for iPad/Mobile clickability */
            bottom: 20px;
            right: 20px;
            z-index: 100;
            width: auto;
            margin-top: 0;
            padding: 12px 30px;
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
            display: none; /* Initially hidden */
            touch-action: manipulation;
        }
        #next-btn:hover { background: #0d47a1; transform: translateY(-2px); }

        /* --- Collection & Mistake & History --- */
        .list-screen-content { padding: 10px; }
        .list-item-card {
            background: #fff; border-radius: 10px; padding: 20px; margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #ddd;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; transition: 0.2s;
        }
        .list-item-card:hover { transform: translateX(5px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .list-item-card.fav-item { border-left-color: var(--favorite-color); }
        .list-item-card.mistake-item { border-left-color: var(--wrong-color); }
        
        .list-item-title { font-size: 1.2em; font-weight: bold; color: #333; }
        .list-item-info { color: #666; font-size: 0.9em; margin-top: 5px; }
        .list-empty-msg { text-align: center; color: #888; font-size: 1.2em; margin-top: 30px; }

        /* --- Modal --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 20000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 10px; max-width: 90%; max-height: 90%; position: relative; text-align: center; overflow-y: auto;}
        .modal-close { position: absolute; top: -15px; right: -15px; background: red; color: white; width: 30px; height: 30px; border-radius: 50%; border: 2px solid white; cursor: pointer; font-weight: bold;}

        /* --- AI Chat Window Styles --- */
        #ai-chat-window {
            position: fixed; bottom: 20px; right: 20px; width: 350px; height: 500px;
            background: #fff; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            border: 2px solid var(--primary-color); z-index: 20001; /* Above almost everything */
            display: none; flex-direction: column; overflow: hidden; font-size: 0.95em;
        }
        .ai-header {
            background: var(--primary-color); color: white; padding: 12px 15px;
            display: flex; justify-content: space-between; align-items: center; font-weight: bold;
        }
        .ai-header-close { cursor: pointer; font-size: 1.2em; background: rgba(255,255,255,0.2); border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center;}
        .ai-header-close:hover { background: rgba(255,255,255,0.4); }
        .ai-messages {
            flex: 1; padding: 15px; overflow-y: auto; background: var(--bg-color);
            display: flex; flex-direction: column; gap: 10px;
        }
        .ai-msg { padding: 8px 12px; border-radius: 10px; max-width: 85%; line-height: 1.4; word-wrap: break-word; }
        .ai-msg.user { align-self: flex-end; background: var(--primary-color); color: white; border-bottom-right-radius: 2px; }
        .ai-msg.bot { align-self: flex-start; background: white; border: 1px solid #ddd; color: #333; border-bottom-left-radius: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .ai-input-area {
            padding: 10px; background: white; border-top: 1px solid #eee; display: flex; gap: 8px;
        }
        .ai-input { flex: 1; padding: 8px 12px; border: 1px solid #ccc; border-radius: 20px; outline: none; transition: 0.3s; }
        .ai-input:focus { border-color: var(--primary-color); }
        .ai-send-btn { background: var(--primary-color); color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .ai-send-btn:hover { background: #0d47a1; }

        /* Firebase Status Indicator */
        #firebase-status {
            font-size: 0.8em; color: var(--primary-color); background: rgba(255,255,255,0.8);
            padding: 2px 8px; border-radius: 10px; margin-right: 10px; font-weight: bold;
        }

        /* RWD */
        @media (max-width: 768px) {
            #level-screen-content { flex-direction: column; overflow-y: auto; height: 100%;}
            /* Stack article and questions vertically on mobile */
            .question-box { flex-direction: column; }
            .article-section { 
                width: 100%; 
                border-right: none; 
                border-bottom: 2px solid #ccc;
                height: 40%; /* Fixed height for top part on mobile */
            }
            .questions-section {
                width: 100%;
                height: 60%; /* Fixed height for bottom part on mobile */
            }
            body { padding-top: 70px; } /* Adjust for header */
            #music-player-bar { height: 60px; padding: 0 10px; }
            
            /* Responsive Adjustments for Music Player */
            .player-center { 
                flex-direction: column; /* Keep stacked on mobile */
                margin: 0 5px; 
            }
            .song-info-container { 
                max-width: 150px; 
                width: 90%;
                font-size: 0.8em;
                margin-right: 0;
                margin-bottom: 5px;
            }
            .ctrl-btn { font-size: 1.2em; padding: 3px; }
            .volume-slider { width: 40px; }
            
            #firebase-status { display: none; } /* Hide status on small mobile if crowded */
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <!-- Music Player (HTML5 Audio) -->
    <div id="music-player-bar">
        <div class="player-left">
            <div class="player-icon">üéµ</div>
        </div>
        
        <div class="player-center">
            <div class="song-info-container">
                <span id="song-title-display" class="song-title">Loading Music...</span>
            </div>
            <div class="player-controls">
                <button class="ctrl-btn" onclick="audioPlayer.prev()" title="Previous">‚èÆ</button>
                <button id="main-play-btn" class="ctrl-btn" onclick="audioPlayer.toggle()" title="Play/Pause">‚ñ∂</button>
                <button class="ctrl-btn" onclick="audioPlayer.next()" title="Next (Random)">‚è≠</button>
                
                <div class="volume-container">
                    <span style="font-size:0.8em; color:var(--primary-color);">üîä</span>
                    <input type="range" id="volume-slider" class="volume-slider" min="0" max="1" step="0.1" value="0.3" oninput="audioPlayer.setVolume(this.value)">
                </div>
            </div>
        </div>
        
        <div class="player-right">
            <span id="firebase-status">‚òÅÔ∏è Connecting...</span>
            <div class="player-controls">
                <!-- AI Button -->
                <button id="ai-btn" class="ctrl-btn" onclick="toggleChatWindow()" title="AI Tutor">ü§ñ</button>
            </div>
        </div>
    </div>

    <!-- Welcome Screen -->
    <div id="welcome-screen" class="container-box fade-in">
        <h1>English Reading Comprehension Quiz</h1>
        <div style="font-size: 4em; text-align: center; margin: 20px;">üìñüå∏üìù</div>
        <p style="text-align: center; font-size: 1.2em;">Please enter your name to start the challenge!</p>
        
        <div style="text-align:center;">
            <input type="text" id="username" placeholder="Enter name..." />
        </div>
        
        <div class="avatar-selection">
            <img src="images/Chris.png" class="avatar-option selected" onclick="selectAvatar('Chris.png', this)">
            <img src="images/Louis.png" class="avatar-option" onclick="selectAvatar('Louis.png', this)">
            <img src="images/kitty.png" class="avatar-option" onclick="selectAvatar('kitty.png', this)">
        </div>

        <div id="quick-login-area" class="quick-login-area"></div>

        <div style="text-align:center; margin-top: 30px;">
            <button class="btn" onclick="loginAndStart()">üöÄ Start Challenge</button>
        </div>
    </div>

    <!-- Dashboard (Level Screen) -->
    <div id="level-screen" class="container-box fade-in" style="display: none;">
        <div style="text-align: center; margin-bottom: 20px;">
            <img id="user-avatar-display" src="" style="width:40px; height:40px; border-radius:50%; vertical-align:middle; border:2px solid #fff; box-shadow:0 2px 5px rgba(0,0,0,0.2);">
            <span style="font-size: 1.2em; font-weight: bold; margin-left: 10px;">Challenger: <span id="display-name" style="color:var(--primary-color);"></span></span>
        </div>

        <div id="level-screen-content">
            <!-- Left: Standard Zone -->
            <div class="dashboard-std-zone">
                <div class="dashboard-title">
                    <span>üìö Reading Challenge Mode</span>
                    <span id="overall-progress" class="overall-progress">Total Progress: 0%</span>
                </div>
                <div id="level-grid" class="level-grid"></div>
            </div>
        </div>

        <!-- Bottom Tools -->
        <div class="dashboard-tools">
            <button id="btn-mistake" class="btn btn-red" onclick="showMistakes()">üìï Mistakes</button>
            <button class="btn btn-pink" onclick="showFavorites()">‚≠ê Favorites</button>
            <button class="btn btn-green" onclick="showHistory()">üèÜ History</button>
            <button class="btn btn-gray" onclick="logout()">üö™ Logout</button>
        </div>
    </div>

    <!-- Standard Quiz Mode (Reading Comprehension) -->
    <div id="quiz-content" class="container-box fade-in" style="display: none;">
        <div class="quiz-header">
            <h3 id="level-title" style="margin:0; color:var(--primary-color);">Level X</h3>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-gray btn-sm" style="padding: 5px 10px;" onclick="exitQuiz()">üè† Exit</button>
            </div>
        </div>
        
        <div class="progress-bar-container">
            <div id="progress-bar" class="progress-bar-fill"></div>
        </div>
        <div class="status-bar">
            Progress: <span id="current-q-num">1</span> / <span id="total-q-num">5</span>
        </div>

        <div id="question-container">
            <div class="question-box">
                <div class="article-section">
                    <div class="article-title-bar">
                        <div id="article-title" class="article-title"></div>
                        <div id="fav-icon" class="fav-heart" title="Add to Favorites">‚ô°</div>
                    </div>
                    <div id="article-text" class="article-content"></div>
                </div>
                <div class="questions-section">
                    <div id="sub-questions-container"></div>
                </div>
            </div>
        </div>
        
        <button id="next-btn" class="btn" onclick="nextQuestion()">Next ‚û°Ô∏è</button>
    </div>

    <!-- Score Screen -->
    <div id="score-box" class="container-box fade-in" style="display: none; text-align: center;">
        <h2 style="color: var(--primary-color);">üéâ Level Complete</h2>
        <p style="font-size: 1.5em; margin: 10px;">Challenger: <span id="final-name"></span></p>
        <div style="font-size: 4em; font-weight: bold; color: var(--accent-color); margin: 20px 0;">
            <span id="final-score">0</span> <span style="font-size:0.4em; color:#777;">pts</span>
        </div>
        <div id="score-comment" style="font-size: 1.2em; color: #e67e22; margin-bottom: 20px;"></div>
        
        <div id="unlock-msg" style="display:none; color:var(--correct-color); font-weight:bold; font-size:1.2em; margin-bottom:15px;">üîì Next Level Unlocked!</div>

        <div style="display: flex; justify-content: center; gap: 15px;">
            <button class="btn" onclick="goToDashboard()">üó∫Ô∏è Return to Map</button>
        </div>
    </div>

    <!-- Favorites Screen -->
    <div id="favorites-screen" class="container-box fade-in" style="display: none;">
        <h2 style="color: var(--favorite-color);">‚≠ê My Favorites</h2>
        <div id="favorites-list" class="list-screen-content"></div>
        <div style="text-align: center; margin-top: 20px;">
            <button class="btn" onclick="goToDashboard()">üó∫Ô∏è Return</button>
        </div>
    </div>

    <!-- Mistakes Screen -->
    <div id="mistakes-screen" class="container-box fade-in" style="display: none;">
        <h2 style="color: var(--wrong-color);">üìï Mistake Review</h2>
        <div id="mistakes-list" class="list-screen-content"></div>
        <div style="text-align: center; margin-top: 20px;">
            <button class="btn" onclick="goToDashboard()">üó∫Ô∏è Return</button>
        </div>
    </div>

    <!-- History Screen -->
    <div id="history-screen" class="container-box fade-in" style="display: none;">
        <h2>üèÜ Hall of Fame</h2>
        <ul id="history-list" style="list-style: none; padding: 0;"></ul>
        <div style="text-align: center; margin-top: 20px;">
            <button class="btn" onclick="goToDashboard()">üó∫Ô∏è Return</button>
        </div>
    </div>

    <!-- AI Chat Window -->
    <div id="ai-chat-window">
        <div class="ai-header">
            <div style="display:flex; align-items:center; gap:10px;">
                <span>ü§ñ AI Tutor</span>
                <span class="ai-header-close" onclick="resetAiKey()" title="Reset API Key" style="font-size: 0.9em;">üîë</span>
            </div>
            <span class="ai-header-close" onclick="toggleChatWindow()">√ó</span>
        </div>
        <div id="ai-messages" class="ai-messages">
            <div class="ai-msg bot">Hello! I am your AI Tutor. Ask me anything!</div>
        </div>
        <div class="ai-input-area">
            <input type="text" id="ai-input" class="ai-input" placeholder="Input question..." onkeypress="handleAiKeypress(event)">
            <button class="ai-send-btn" onclick="sendAiMessage()">Send</button>
        </div>
    </div>

    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, updateDoc, onSnapshot, getDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // --- 1. FIREBASE CONFIG & INIT ---
        const firebaseConfig = {
  apiKey: "AIzaSyAxQFt76ZPXE7d0i1XeNZ1yiiD2WYNIfHs",
  authDomain: "chinese-learning-47f4d.firebaseapp.com",
  projectId: "chinese-learning-47f4d",
  storageBucket: "chinese-learning-47f4d.firebasestorage.app",
  messagingSenderId: "76289812052",
  appId: "1:76289812052:web:898384a916f9f341f62fc1"
};

        // --- EXTRACTED COLLECTION NAME ---
        // Originally: const APP_PREFIX = 'EnglishQuizSet3-1_';
        const COLLECTION_NAME = 'EnglishQuizSet3-1';

        let db, auth, app;
        let isFirebaseReady = false;
        let currentUserDocUnsub = null;
        let globalUsersUnsub = null;

        // --- LOCAL CACHE (Mirrors what used to be in localStorage) ---
        // This allows existing sync functions (like renderLevelGrid) to work with minimal changes
        let localCache = {
            quizProgress: { maxLevel: 1, scores: {} },
            favorites: [],
            mistakes: [],
            history: [],
            savedStates: {} // To store level resume data: { level_1: {...state...} }
        };

        // Initialize Firebase
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Anonymous Login
            signInAnonymously(auth).then(() => {
                console.log("Firebase: Signed in anonymously");
                isFirebaseReady = true;
                updateConnectionStatus("‚òÅÔ∏è Synced");
                
                // Start listening to Global Users List immediately
                listenToGlobalUsers();
            }).catch((error) => {
                console.error("Firebase Auth Error:", error);
                updateConnectionStatus("‚ö†Ô∏è Offline Mode");
                // Fallback to localStorage logic could go here, but for now we warn
            });

        } catch (e) {
            console.error("Firebase Init Failed (Check Config):", e);
            updateConnectionStatus("‚ùå Config Error");
        }

        function updateConnectionStatus(msg) {
            const statusEl = document.getElementById('firebase-status');
            if(statusEl) statusEl.innerText = msg;
        }

        // --- 1. SETTINGS & CONFIGURATION ---
        const MUSIC_CONFIG =  {
            username: 'nicktsai88',
            repo: 'Music',
            folder: '' // Ëã•Âú®Ê†πÁõÆÈåÑË´ãÁïôÁ©∫Ôºå‰æãÂ¶Ç: ''
        };

        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=";

        // Configuration and Globals
        const LEVEL_CONFIG = [];
        for (let i = 0; i < 29; i++) {
            LEVEL_CONFIG.push(5);
        }
        LEVEL_CONFIG.push(4); // Level 30

        const APP_PREFIX = 'EnglishQuizSet3-1_'; // Kept for legacy key generation if needed (e.g. Gemini key)
        
        let allQuestions = [], currentQuizData = [];
        let userName = "", currentAvatar = "Chris.png";
        
        // Quiz State
        let quizState = {
            mode: 'level', // level, favorites, mistakes
            level: 1,
            score: 0, 
            totalSubQuestions: 0,
            currentIndex: 0,
            pageAnsweredCount: 0,
            pageState: {},
            qIds: [] // Question IDs for non-level modes
        };

        const audioCorrect = new Audio('sounds/correct.mp3'); audioCorrect.volume = 0.4;
        const audioFail = new Audio('sounds/fail.mp3'); audioFail.volume = 0.4;

        // --- 2. HTML5 AUDIO PLAYER LOGIC ---
        const audioPlayer = {
            element: new Audio(),
            playlist: [],
            currentIndex: 0,
            isPlaying: false,

            init: function() {
                this.element.volume = 0.3;
                this.element.onended = () => this.next();
                this.element.onerror = () => {
                    console.error("Audio Error, skipping track");
                    this.next();
                };
                this.fetchPlaylist();
            },

            fetchPlaylist: async function() {
                const titleDisplay = document.getElementById('song-title-display');
                try {
                    titleDisplay.innerText = "Fetching Music...";
                    const path = MUSIC_CONFIG.folder ? `/${MUSIC_CONFIG.folder}` : '';
                    const url = `https://api.github.com/repos/${MUSIC_CONFIG.username}/${MUSIC_CONFIG.repo}/contents${path}`;
                    
                    const response = await fetch(url);
                    if (!response.ok) throw new Error("GitHub API Failed");
                    
                    const data = await response.json();
                    
                    // Filter for .mp3 files
                    this.playlist = data
                        .filter(file => file.name.toLowerCase().endsWith('.mp3'))
                        .map(file => ({
                            name: file.name.replace(/\.mp3$/i, '').replace(/_/g, ' '),
                            src: file.download_url
                        }));

                    if (this.playlist.length === 0) {
                        titleDisplay.innerText = "No MP3s found";
                        return;
                    }

                    // Shuffle
                    this.shufflePlaylist();
                    
                    // Set initial track but don't play yet
                    this.currentIndex = 0;
                    this.loadTrack(0);
                    titleDisplay.innerText = "Ready to Play üéµ";

                } catch (error) {
                    console.error("Music Load Error:", error);
                    titleDisplay.innerText = "Music Load Failed";
                }
            },

            shufflePlaylist: function() {
                for (let i = this.playlist.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [this.playlist[i], this.playlist[j]] = [this.playlist[j], this.playlist[i]];
                }
            },

            loadTrack: function(index) {
                if (this.playlist.length === 0) return;
                const track = this.playlist[index];
                this.element.src = track.src;
                
                // Update UI
                const titleEl = document.getElementById('song-title-display');
                titleEl.innerText = track.name;
                
                // Marquee effect logic
                if (track.name.length > 20) {
                    titleEl.classList.add('scrolling-text');
                } else {
                    titleEl.classList.remove('scrolling-text');
                }
            },

            play: function() {
                if (this.playlist.length === 0) return;
                
                const playPromise = this.element.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        this.isPlaying = true;
                        this.updateBtnUI();
                    }).catch(error => {
                        console.log("Autoplay prevented or error:", error);
                        this.isPlaying = false;
                        this.updateBtnUI();
                    });
                }
            },

            pause: function() {
                this.element.pause();
                this.isPlaying = false;
                this.updateBtnUI();
            },

            toggle: function() {
                if (this.isPlaying) this.pause();
                else this.play();
            },

            next: function() {
                if (this.playlist.length === 0) return;
                this.currentIndex = (this.currentIndex + 1) % this.playlist.length;
                this.loadTrack(this.currentIndex);
                this.play();
            },

            prev: function() {
                if (this.playlist.length === 0) return;
                this.currentIndex = (this.currentIndex - 1 + this.playlist.length) % this.playlist.length;
                this.loadTrack(this.currentIndex);
                this.play();
            },

            setVolume: function(val) {
                this.element.volume = val;
            },

            updateBtnUI: function() {
                document.getElementById('main-play-btn').innerText = this.isPlaying ? '‚è∏' : '‚ñ∂';
            }
        };

        // Initialize Audio Logic
        audioPlayer.init();

        // --- Initialization ---
        fetch('questions.json').then(res => res.json())
            .then(data => { 
                allQuestions = data; 
                // renderQuickLogin is called after Firebase listener is active
            })
            .catch(e => console.error("Error loading questions:", e));

        // --- FIREBASE DATA LOGIC ---

        // Listen to global users list
        function listenToGlobalUsers() {
            if(!isFirebaseReady) return;
            const globalRef = doc(db, COLLECTION_NAME, 'global_users');
            
            globalUsersUnsub = onSnapshot(globalRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    renderQuickLogin(data.users || []);
                } else {
                    renderQuickLogin([]);
                }
            });
        }

        // Listen to current user data
        function listenToUserData() {
            if(!isFirebaseReady || !userName) return;
            const userRef = doc(db, COLLECTION_NAME, userName);

            if(currentUserDocUnsub) currentUserDocUnsub(); // Unsubscribe prev if any

            currentUserDocUnsub = onSnapshot(userRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Merge into localCache
                    localCache.quizProgress = data.quizProgress || { maxLevel: 1, scores: {} };
                    localCache.favorites = data.favorites || [];
                    localCache.mistakes = data.mistakes || [];
                    localCache.history = data.history || [];
                    localCache.savedStates = data.savedStates || {};
                    
                    // If dashboard is visible, refresh it
                    if(document.getElementById('level-screen').style.display === 'block') {
                        renderLevelGrid();
                    }
                    if(document.getElementById('favorites-screen').style.display === 'block') {
                        showFavorites();
                    }
                    if(document.getElementById('mistakes-screen').style.display === 'block') {
                        showMistakes();
                    }
                }
            });
        }

        // --- Login & Navigation ---
        window.selectAvatar = function(img, el) {
            currentAvatar = img;
            document.querySelectorAll('.avatar-option').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
        }

        window.loginAndStart = async function() {
            const name = document.getElementById('username').value.trim();
            if(!name) return alert('Please enter a name');
            userName = name;

            // Wait for firebase connection if not ready?
            if(!isFirebaseReady) {
               alert("Connecting to server, please wait...");
               return;
            }

            await saveUserGlobal(); // Add to global list if new
            listenToUserData();     // Start syncing user specific data
            
            // Trigger Audio Play on user interaction
            audioPlayer.play();
            
            goToDashboard();
        }

        async function saveUserGlobal() {
            if(!isFirebaseReady) return;
            const globalRef = doc(db, COLLECTION_NAME, 'global_users');
            // Use arrayUnion to add user to list
            try {
                await setDoc(globalRef, {
                    users: arrayUnion({ name: userName, avatar: currentAvatar })
                }, { merge: true });
            } catch(e) {
                console.error("Save Global User Error", e);
            }
        }
        
        function renderQuickLogin(users) {
            // users comes from snapshot
            const container = document.getElementById('quick-login-area');
            // Filter unique names just in case
            const uniqueUsers = users.filter((v,i,a)=>a.findIndex(v2=>(v2.name===v.name))===i);

            container.innerHTML = uniqueUsers.map(u => `
                <div class="user-tag" onclick="quickLogin('${u.name}', '${u.avatar}')">
                    <img src="images/${u.avatar}" style="width:20px;height:20px;border-radius:50%;">${u.name}
                    <span class="delete-user" onclick="event.stopPropagation();deleteUser('${u.name}')">√ó</span>
                </div>
            `).join('');
        }

        window.quickLogin = function(name, av) {
            document.getElementById('username').value = name;
            currentAvatar = av;
            loginAndStart();
        }

        window.deleteUser = async function(name) {
            if(!confirm(`Delete data for ${name}?`)) return;
            
            if(!isFirebaseReady) return alert("Offline cannot delete");

            try {
                // 1. Remove from global list (Need avatar to match object exactly, but we only have name here easily)
                // We'll fetch the list first to find the object
                const globalRef = doc(db, COLLECTION_NAME, 'global_users');
                const docSnap = await getDoc(globalRef);
                if(docSnap.exists()) {
                    const users = docSnap.data().users || [];
                    const userObj = users.find(u => u.name === name);
                    if(userObj) {
                        await updateDoc(globalRef, {
                            users: arrayRemove(userObj)
                        });
                    }
                }

                // 2. Delete user document is not supported by standard client SDK deleteDoc easily if we want to keep it simple, 
                // but we can just empty it or set a flag. 
                // Actually, let's just delete the doc reference.
                // Note: Standard SDK requires deleting collections? No, just the doc.
                // However, importing deleteDoc was not in my top imports.
                // Let's just remove from the list for the UI.
                
                // If you strictly want to delete data:
                // await deleteDoc(doc(db, COLLECTION_NAME, name)); 

            } catch(e) {
                console.error("Delete failed", e);
            }
        }

        window.goToDashboard = function() {
            hideAllScreens();
            document.getElementById('level-screen').style.display = 'block';
            document.getElementById('display-name').innerText = userName;
            document.getElementById('user-avatar-display').src = "images/" + currentAvatar;
            
            renderLevelGrid();
        }

        function hideAllScreens() {
            document.querySelectorAll('.container-box').forEach(el => el.style.display = 'none');
        }

        // --- Dashboard & Level Selection ---
        function renderLevelGrid() {
            const grid = document.getElementById('level-grid');
            if(!grid) return console.error("Level grid element not found!");
            
            grid.innerHTML = "";
            
            // READ FROM LOCAL CACHE (Populated by Firestore Snapshot)
            let progress = localCache.quizProgress;
            
            if(!progress.scores) progress.scores = {};
            if(!progress.maxLevel) progress.maxLevel = 1;

            // Calculate progress
            let completedLevels = Object.keys(progress.scores).length;
            let percent = Math.round((completedLevels / LEVEL_CONFIG.length) * 100);
            document.getElementById('overall-progress').innerText = `Total Progress: ${percent}%`;

            LEVEL_CONFIG.forEach((_, idx) => {
                const level = idx + 1;
                const btn = document.createElement('button');
                btn.className = 'level-grid-btn';
                
                if (level <= progress.maxLevel) {
                    const score = progress.scores[level];
                    let icon = 'üìñ'; 
                    if (score !== undefined) {
                        if (score >= 90) icon = 'ü•á'; 
                        else if (score >= 70) icon = 'ü•à';
                        else icon = 'ü•â';
                    }
                    
                    // Check for saved progress in localCache
                    const hasSaved = localCache.savedStates && localCache.savedStates['level_'+level];
                    const resumeText = hasSaved ? '<div style="font-size:0.8em;color:#e65100;">(Resume)</div>' : '';

                    btn.innerHTML = `<div class="lvl-icon">${icon}</div><div class="lvl-label">Level ${level}</div>${score !== undefined ? `<div class="lvl-score">${score}pts</div>` : ''}${resumeText}`;
                    btn.onclick = () => startQuiz(level);
                } else {
                    btn.disabled = true;
                    btn.innerHTML = `<div class="lvl-icon" style="filter:grayscale(1);">üîí</div><div class="lvl-label">Level ${level}</div>`;
                }
                grid.appendChild(btn);
            });
        }

        // --- Quiz Logic ---
        function startQuiz(level) {
            // Calculate question range
            let startIdx = 0;
            for(let i=0; i<level-1; i++) startIdx += LEVEL_CONFIG[i];
            let endIdx = startIdx + LEVEL_CONFIG[level-1];
            
            // Load questions
            currentQuizData = allQuestions.slice(startIdx, endIdx);
            
            // Check save state from localCache
            const savedState = localCache.savedStates ? localCache.savedStates['level_'+level] : null;

            if (savedState) {
                // Resume
                quizState = savedState;
                quizState.mode = 'level';
                // Recalculate total subquestions to be safe
                let total = 0;
                currentQuizData.forEach(q => total += q.subQuestions.length);
                quizState.totalSubQuestions = total;
            } else {
                // Initialize
                quizState = {
                    mode: 'level',
                    level: level,
                    score: 0,
                    totalSubQuestions: 0,
                    currentIndex: 0,
                    pageAnsweredCount: 0,
                    pageState: {}
                };
                currentQuizData.forEach(q => quizState.totalSubQuestions += q.subQuestions.length);
            }
            
            loadQuizUI();
        }

        function startReviewQuiz(mode, qIds) {
            if (!qIds || qIds.length === 0) return alert("No questions found!");
            
            // Filter questions by ID
            currentQuizData = allQuestions.filter(q => qIds.includes(q.id));
            
            quizState = {
                mode: mode,
                level: 0,
                score: 0,
                totalSubQuestions: 0,
                currentIndex: 0,
                pageAnsweredCount: 0,
                pageState: {},
                qIds: qIds
            };
            
            currentQuizData.forEach(q => quizState.totalSubQuestions += q.subQuestions.length);
            loadQuizUI();
        }

        async function saveQuizProgress() {
            // Only save in level mode
            if(quizState.mode === 'level') {
                if(!isFirebaseReady || !userName) return;
                
                // Update specific field using dot notation for the map
                const fieldPath = `savedStates.level_${quizState.level}`;
                
                try {
                    await updateDoc(doc(db, COLLECTION_NAME, userName), {
                        [fieldPath]: quizState
                    });
                } catch(e) {
                    console.error("Save progress failed", e);
                }
            }
        }

        function loadQuizUI() {
            hideAllScreens();
            document.getElementById('quiz-content').style.display = 'flex'; // Use flex for column layout
            let title = "";
            if (quizState.mode === 'level') title = `üìñ Level ${quizState.level}`;
            else if (quizState.mode === 'favorites') title = `‚≠ê My Favorites`;
            else if (quizState.mode === 'mistakes') title = `üìï Mistake Review`;
            
            document.getElementById('level-title').innerText = title;
            document.getElementById('total-q-num').innerText = currentQuizData.length;
            loadQuestion();
        }

        function loadQuestion() {
            const qData = currentQuizData[quizState.currentIndex];
            if(!qData) return finishQuiz();
            
            // UI Reset
            document.getElementById('next-btn').style.display = 'none';

            // Progress Bar
            document.getElementById('current-q-num').innerText = quizState.currentIndex + 1;
            document.getElementById('progress-bar').style.width = ((quizState.currentIndex) / currentQuizData.length * 100) + '%';
            
            // Article Display
            document.getElementById('article-title').innerText = qData.title;
            document.getElementById('article-text').innerHTML = qData.article;

            // Favorites Button
            const favIcon = document.getElementById('fav-icon');
            updateFavIcon(qData.id);
            favIcon.onclick = () => toggleFavorite(qData.id);

            // Sub-questions Display
            const container = document.getElementById('sub-questions-container');
            container.innerHTML = "";
            
            qData.subQuestions.forEach((subQ, idx) => {
                const subDiv = document.createElement('div');
                subDiv.className = 'sub-question-item';
                subDiv.id = `subq-${subQ.id}`;
                
                // Question Text
                const qText = document.createElement('div');
                qText.className = 'sub-q-text';
                qText.innerHTML = `${idx + 1}. ${subQ.q}`;
                subDiv.appendChild(qText);
                
                // Options List
                const optList = document.createElement('div');
                optList.className = 'option-list';
                
                subQ.options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = `option-btn opt-btn-${subQ.id}`; 
                    
                    if(opt.includes('<img')) {
                        btn.innerHTML = opt;
                    } else {
                        btn.innerText = opt;
                    }
                    
                    btn.onclick = () => handleAnswerImmediate(qData.id, subQ.id, opt, btn, subQ.ans, subQ.explanation);
                    optList.appendChild(btn);
                });
                
                subDiv.appendChild(optList);

                // Explanation
                const expDiv = document.createElement('div');
                expDiv.className = 'single-explanation';
                expDiv.id = `exp-${subQ.id}`;
                expDiv.innerHTML = `<strong>üí° ExplanationÔºö</strong>${subQ.explanation || 'None'}`;
                subDiv.appendChild(expDiv);

                container.appendChild(subDiv);
            });

            // --- Restore State ---
            if (quizState.pageState && Object.keys(quizState.pageState).length > 0) {
                qData.subQuestions.forEach(subQ => {
                    const savedAnswer = quizState.pageState[subQ.id];
                    if (savedAnswer) {
                        const allBtns = document.querySelectorAll(`.opt-btn-${subQ.id}`);
                        allBtns.forEach(btn => {
                            btn.disabled = true;
                            
                            let btnKey = "";
                            const text = btn.innerText || btn.innerHTML;
                            if(text.includes("(A)")) btnKey = "A";
                            else if(text.includes("(B)")) btnKey = "B";
                            else if(text.includes("(C)")) btnKey = "C";
                            else if(text.includes("(D)")) btnKey = "D";
                            else btnKey = text;

                            if (savedAnswer.selected === btn.innerText || 
                                (btn.innerHTML.includes('<img') && savedAnswer.selected.includes('<img'))) {
                                if (savedAnswer.isCorrect) btn.classList.add('correct');
                                else btn.classList.add('wrong');
                            }
                            if (btnKey === subQ.ans) btn.classList.add('correct');
                        });

                        const expDiv = document.getElementById(`exp-${subQ.id}`);
                        if(expDiv) expDiv.style.display = 'block';
                    }
                });

                if (quizState.pageAnsweredCount >= qData.subQuestions.length) {
                    document.getElementById('next-btn').style.display = 'block';
                }
            }
        }

        window.handleAnswerImmediate = function(qGroupId, subQId, selectedValue, btnElement, correctAns, explanationText) {
            const allBtns = document.querySelectorAll(`.opt-btn-${subQId}`);
            allBtns.forEach(b => b.disabled = true);

            let userKey = "";
            if(selectedValue.includes("(A)")) userKey = "A";
            else if(selectedValue.includes("(B)")) userKey = "B";
            else if(selectedValue.includes("(C)")) userKey = "C";
            else if(selectedValue.includes("(D)")) userKey = "D";
            else userKey = selectedValue;

            let isCorrect = (userKey === correctAns);
            
            // Update State
            if (!quizState.pageState) quizState.pageState = {};
            quizState.pageState[subQId] = { selected: selectedValue, isCorrect: isCorrect };
            quizState.pageAnsweredCount++;

            if(isCorrect) {
                btnElement.classList.add('correct');
                quizState.score++;
                audioCorrect.play().catch(()=>{});
                confetti({ particleCount: 30, origin: { y: 0.8 }, spread: 50 });
            } else {
                btnElement.classList.add('wrong');
                audioFail.play().catch(()=>{});
                
                // Add to Mistakes
                addToMistakes(qGroupId);

                allBtns.forEach(b => {
                    let bKey = "";
                    let bText = b.innerText || b.innerHTML;
                    if(bText.includes("(A)")) bKey = "A";
                    else if(bText.includes("(B)")) bKey = "B";
                    else if(bText.includes("(C)")) bKey = "C";
                    else if(bText.includes("(D)")) bKey = "D";
                    else bKey = bText;

                    if(bKey === correctAns) b.classList.add('correct');
                });
            }

            const expDiv = document.getElementById(`exp-${subQId}`);
            if(expDiv) expDiv.style.display = 'block';

            saveQuizProgress();

            const currentQData = currentQuizData[quizState.currentIndex];
            if(quizState.pageAnsweredCount >= currentQData.subQuestions.length) {
                document.getElementById('next-btn').style.display = 'block';
            }
        }

        window.nextQuestion = function() {
            quizState.currentIndex++;
            quizState.pageAnsweredCount = 0;
            quizState.pageState = {}; 
            
            saveQuizProgress();
            loadQuestion();
            
            // Reset scroll for both panels
            document.querySelector('.questions-section').scrollTop = 0;
            document.querySelector('.article-section').scrollTop = 0;
        }

        async function finishQuiz() {
            if(quizState.mode === 'level') {
                // Remove progress for this level upon completion
                if(isFirebaseReady && userName) {
                     const fieldPath = `savedStates.level_${quizState.level}`;
                     try {
                         // We can set it to null or use FieldValue.delete() but direct update to empty obj is easier
                         // Using update with dot notation to nullify or delete
                         // For simplicity in this structure, we just update the progress below and the state stays 'complete' or we can ignore it
                     } catch(e){}
                }
            }

            document.getElementById('quiz-content').style.display = 'none';
            document.getElementById('score-box').style.display = 'block';
            
            const finalScore = Math.round((quizState.score / quizState.totalSubQuestions) * 100);
            document.getElementById('final-score').innerText = finalScore;
            document.getElementById('final-name').innerText = userName;
            
            if(quizState.mode === 'level') {
                let progress = localCache.quizProgress || { maxLevel: 1, scores: {} };
                
                // Update score
                let oldScore = progress.scores[quizState.level] || 0;
                let newScores = { ...progress.scores };
                
                if(finalScore > oldScore) newScores[quizState.level] = finalScore;
                else if (!newScores[quizState.level]) newScores[quizState.level] = finalScore; 
                
                // Unlock next level
                let unlocked = false;
                let newMaxLevel = progress.maxLevel;
                if(quizState.level === progress.maxLevel && quizState.level < LEVEL_CONFIG.length) {
                    newMaxLevel++;
                    unlocked = true;
                }
                
                // SAVE PROGRESS TO FIREBASE
                if(isFirebaseReady && userName) {
                    const userRef = doc(db, COLLECTION_NAME, userName);
                    await setDoc(userRef, {
                        quizProgress: { maxLevel: newMaxLevel, scores: newScores }
                    }, { merge: true });
                }

                document.getElementById('unlock-msg').style.display = unlocked ? 'block' : 'none';
            } else {
                document.getElementById('unlock-msg').style.display = 'none';
            }
            
            let cmt = "Keep it up!";
            if(finalScore == 100) cmt = "Perfect! Amazing work!";
            else if(finalScore >= 80) cmt = "Great job! Keep going!";
            else if(finalScore >= 60) cmt = "Good effort, keep practicing!";
            document.getElementById('score-comment').innerText = cmt;

            saveHistory(finalScore, quizState.mode === 'level' ? `Level ${quizState.level}` : (quizState.mode === 'favorites' ? 'Favorites' : 'Mistakes'));
        }

        // --- Favorites & Mistakes ---
        async function toggleFavorite(qId) {
            if(!isFirebaseReady || !userName) return;
            
            let favs = localCache.favorites || [];
            const index = favs.indexOf(qId);
            let newFavs = [...favs];
            
            if (index > -1) {
                newFavs.splice(index, 1);
            } else {
                newFavs.push(qId);
            }
            
            // Optimistic Update
            localCache.favorites = newFavs;
            updateFavIcon(qId);
            
            // Firebase Update
            await updateDoc(doc(db, COLLECTION_NAME, userName), { favorites: newFavs });
        }

        function updateFavIcon(qId) {
            let favs = localCache.favorites || [];
            const icon = document.getElementById('fav-icon');
            if (favs.includes(qId)) {
                icon.innerHTML = '‚ô•';
                icon.classList.add('active');
            } else {
                icon.innerHTML = '‚ô°';
                icon.classList.remove('active');
            }
        }

        async function addToMistakes(qId) {
            if(!isFirebaseReady || !userName) return;

            let mistakes = localCache.mistakes || [];
            if (!mistakes.includes(qId)) {
                await updateDoc(doc(db, COLLECTION_NAME, userName), {
                    mistakes: arrayUnion(qId)
                });
            }
        }

        window.showFavorites = function() {
            hideAllScreens();
            document.getElementById('favorites-screen').style.display = 'block';
            const list = document.getElementById('favorites-list');
            list.innerHTML = "";
            
            let favs = localCache.favorites || [];
            if (favs.length === 0) {
                list.innerHTML = "<div class='list-empty-msg'>No favorites yet!<br>Go practice and add some!</div>";
                return;
            }

            const favQuestions = allQuestions.filter(q => favs.includes(q.id));
            favQuestions.forEach(q => {
                const item = document.createElement('div');
                item.className = 'list-item-card fav-item';
                item.innerHTML = `<div class="list-item-title">${q.title}</div><div class="list-item-info">${q.subQuestions.length} Questions</div>`;
                item.onclick = () => startReviewQuiz('favorites', [q.id]);
                list.appendChild(item);
            });
            
            // "Practice All" button
            if (favQuestions.length > 1) {
                const btnAll = document.createElement('button');
                btnAll.className = "btn";
                btnAll.style.marginTop = "20px";
                btnAll.style.width = "100%";
                btnAll.innerText = "üöÄ Practice All Favorites";
                btnAll.onclick = () => startReviewQuiz('favorites', favs);
                list.appendChild(btnAll);
            }
        }

        window.showMistakes = function() {
            hideAllScreens();
            document.getElementById('mistakes-screen').style.display = 'block';
            const list = document.getElementById('mistakes-list');
            list.innerHTML = "";
            
            let mistakes = localCache.mistakes || [];
            if (mistakes.length === 0) {
                list.innerHTML = "<div class='list-empty-msg'>Great! No mistakes recorded!</div>";
                return;
            }

            const mistakeQuestions = allQuestions.filter(q => mistakes.includes(q.id));
            mistakeQuestions.forEach(q => {
                const item = document.createElement('div');
                item.className = 'list-item-card mistake-item';
                item.innerHTML = `<div class="list-item-title">${q.title}</div><div class="list-item-info">${q.subQuestions.length} Questions</div>`;
                item.onclick = () => startReviewQuiz('mistakes', [q.id]);
                list.appendChild(item);
            });

            if (mistakeQuestions.length > 1) {
                const btnAll = document.createElement('button');
                btnAll.className = "btn btn-red";
                btnAll.style.marginTop = "20px";
                btnAll.style.width = "100%";
                btnAll.innerText = "üöÄ Review All Mistakes";
                btnAll.onclick = () => startReviewQuiz('mistakes', mistakes);
                list.appendChild(btnAll);
            }
        }

        // --- Common Utils ---
        async function saveHistory(score, modeTitle) {
            if(!isFirebaseReady || !userName) return;

            const newEntry = {
                date: new Date().toLocaleString(),
                score: score,
                mode: modeTitle
            };
            
            await updateDoc(doc(db, COLLECTION_NAME, userName), {
                history: arrayUnion(newEntry)
            });
        }
        
        window.showHistory = function() {
            hideAllScreens();
            document.getElementById('history-screen').style.display = 'block';
            const list = document.getElementById('history-list');
            
            let history = localCache.history || [];
            // Sort by date (simple approach assumes date string is roughly chronological or insertion order)
            // Ideally use timestamp in firestore, but we kept structure
            
            list.innerHTML = history.slice().reverse().map(h => `
                <li style="background:#fff; padding:15px; border-bottom:1px solid #eee; margin-bottom:10px; border-radius:5px;">
                    <strong>${h.mode}</strong> - <span style="color:${h.score>=60?'green':'red'}">${h.score}pts</span>
                    <br><small>${h.date}</small>
                </li>
            `).join('') || '<p style="text-align:center">No records</p>';
        }

        window.logout = function() { location.reload(); }
        window.exitQuiz = function() { 
            // Auto-saved, just exit
            goToDashboard(); 
        }

        // --- AI Chat Logic ---
        window.toggleChatWindow = function() {
            const win = document.getElementById('ai-chat-window');
            win.style.display = win.style.display === 'flex' ? 'none' : 'flex';
        }

        window.handleAiKeypress = function(e) {
            if (e.key === 'Enter') sendAiMessage();
        }

        window.resetAiKey = function() {
            if(confirm("Are you sure you want to clear your API Key?")) {
                localStorage.removeItem(APP_PREFIX + 'gemini_api_key');
                alert("API Key cleared!");
            }
        }

        window.sendAiMessage = async function() {
            const input = document.getElementById('ai-input');
            const msgArea = document.getElementById('ai-messages');
            const userText = input.value.trim();
            
            if (!userText) return;

            let apiKey = localStorage.getItem(APP_PREFIX + 'gemini_api_key');

            if (!apiKey) {
                const inputKey = prompt("Please enter your Google Gemini API Key:\n(Your key is stored locally in your browser)");
                if (!inputKey || inputKey.trim() === "") {
                    alert("API Key required for AI Tutor.");
                    return;
                }
                apiKey = inputKey.trim();
                localStorage.setItem(APP_PREFIX + 'gemini_api_key', apiKey);
            }

            const userMsg = document.createElement('div');
            userMsg.className = 'ai-msg user';
            userMsg.innerText = userText;
            msgArea.appendChild(userMsg);
            
            input.value = '';
            msgArea.scrollTop = msgArea.scrollHeight;

            const loadingMsg = document.createElement('div');
            loadingMsg.className = 'ai-msg bot';
            loadingMsg.innerText = 'Thinking...';
            loadingMsg.id = 'ai-loading';
            msgArea.appendChild(loadingMsg);
            msgArea.scrollTop = msgArea.scrollHeight;

            try {
                const response = await fetch(GEMINI_API_URL + apiKey, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: userText }]
                        }],
                        systemInstruction: {
                            parts: [{ text: "You are an English Learning Assistant. Answer clearly and concisely." }]
                        }
                    })
                });

                const data = await response.json();
                
                const loader = document.getElementById('ai-loading');
                if (loader) loader.remove();

                if (data.error) throw new Error(data.error.message);

                const botText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I can't answer that right now.";
                
                const botMsg = document.createElement('div');
                botMsg.className = 'ai-msg bot';
                botMsg.innerText = botText;
                msgArea.appendChild(botMsg);
                
            } catch (error) {
                console.error(error);
                const loader = document.getElementById('ai-loading');
                if (loader) loader.remove();
                
                const errorMsg = document.createElement('div');
                errorMsg.className = 'ai-msg bot';
                errorMsg.style.color = 'red';
                errorMsg.innerText = `Error: ${error.message}`;
                msgArea.appendChild(errorMsg);

                if (error.message.includes('400') || error.message.includes('403') || error.message.includes('key')) {
                    if(confirm("Connection failed. Key might be invalid. Clear key and re-enter?")) {
                        localStorage.removeItem(APP_PREFIX + 'gemini_api_key');
                    }
                }
            }
            
            msgArea.scrollTop = msgArea.scrollHeight;
        }

        // Attach audioPlayer to window for HTML onclick access
        window.audioPlayer = audioPlayer;
    </script>
</body>
</html>